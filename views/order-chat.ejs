<!-- views/order-chat.ejs -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Chat do Pedido - Jyl Store</title>
    <style>
        body { font-family: sans-serif; background-color: #2c2f33; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .chat-header { background-color: #23272a; padding: 15px; text-align: center; }
        .chat-container { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .messages-list { display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; }
        .message.user { background-color: #5865F2; align-self: flex-end; }
        .message.staff { background-color: #4f545c; align-self: flex-start; }
        .chat-form { display: flex; padding: 20px; background-color: #23272a; }
        .status-analise, .status-pending_approval { color: #f0ad4e; }
        .status-approved { color: #5bc0de; }
        .status-entregue { color: #5cb85c; }
        .status-declined { color: #d9534f; }
        .chat-form input { flex-grow: 1; padding: 10px; border: none; border-radius: 5px; background-color: #40444b; color: white; }
        .chat-form button { background-color: #5865F2; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-left: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="chat-header">
        <h1>Pedido #<%= order.id %></h1>
        <p>Status: <span id="order-status" class="status-<%= (order.status || 'desconhecido').toLowerCase() %>"><%= order.status || 'Desconhecido' %></span></p>
    </div>

    <div class="chat-container">
        <div id="messages-list" class="messages-list">
            <!-- As mensagens serão carregadas aqui via JavaScript -->
            <% if (messages && messages.length > 0) { %>
                <% messages.forEach(msg => { %>
                    <div class="message <%= msg.author === 'user' ? 'user' : 'staff' %>">
                        <p><%= msg.content %></p>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </div>

    <form id="chat-form" class="chat-form">
        <input type="text" id="message-input" placeholder="Digite sua mensagem..." autocomplete="off">
        <button type="submit">Enviar</button>
    </form>

    <!-- Inclui a biblioteca do Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const orderId = "<%= order.id %>";
        const userId = "<%= user.id %>";
        const username = "<%= user.username %>";
        const form = document.getElementById('chat-form');
        const input = document.getElementById('message-input');
        const messagesList = document.getElementById('messages-list');

        // 1. Conecta ao servidor
        const socket = io();

        // 2. Entra na sala específica do pedido
        socket.on('connect', () => {
            socket.emit('join_order_room', orderId);
        });

        // 3. Ouve por novas mensagens do servidor
        socket.on('new_message_from_server', (message) => {
            addMessageToUI(message);
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = input.value;
            if (!message) return;

            // 4. Envia a mensagem para o servidor via WebSocket
            socket.emit('chat_message_from_client', { orderId, userId, username, message });

            input.value = '';
        });

        // Função para adicionar uma nova mensagem na tela
        function addMessageToUI(message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            // Adiciona a classe 'user' ou 'staff' com base no autor
            messageDiv.classList.add(message.author === 'user' ? 'user' : 'staff');

            const contentP = document.createElement('p');
            contentP.textContent = message.content;
            messageDiv.appendChild(contentP);

            // Adiciona a nova mensagem no topo da lista
            messagesList.prepend(messageDiv);
        }

        // 5. Verifica o status do pedido periodicamente
        const statusSpan = document.getElementById('order-status');

        function checkStatus() {
            fetch(`/order/status/${orderId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status && statusSpan.textContent !== data.status) {
                        statusSpan.textContent = data.status;
                        // Atualiza a classe para a cor do status
                        statusSpan.className = `status-${data.status.toLowerCase()}`;

                        // Desabilita o formulário se o pedido for entregue ou recusado
                        if (data.status === 'entregue' || data.status === 'declined') {
                            input.disabled = true;
                            input.placeholder = 'Este chat foi finalizado.';
                            document.querySelector('#chat-form button').disabled = true;
                        }
                    }
                })
                .catch(err => console.error('Erro ao buscar status do pedido:', err));
        }

        setInterval(checkStatus, 5000); // Verifica a cada 5 segundos
    </script>
</body>
</html>