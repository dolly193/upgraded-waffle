<!-- views/awaiting-payment.ejs -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Aguardando Pagamento - Jyl Store</title>
    <style>
        body { font-family: sans-serif; background-color: #2c2f33; color: white; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background-color: #23272a; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: center; max-width: 600px; width: 100%; }
        h1 { color: #fff; margin-bottom: 0.5rem; }
        p { color: #b9bbbe; }
        .product-info { background-color: #2f3136; padding: 1rem; border-radius: 5px; margin: 1.5rem 0; }
        .product-info h2 { margin: 0 0 10px 0; color: #5865F2; }
        .price { font-size: 1.5em; font-weight: bold; color: #43b581; }
        .pix-section { margin-top: 1.5rem; }
        .pix-key { background-color: #1e1f22; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 1.1em; color: #dcddde; word-wrap: break-word; border: 1px dashed #4f545c; }
        .upload-form { margin-top: 2rem; }
        .upload-form input[type="file"] { background-color: #40444b; padding: 10px; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .upload-form button { background-color: #5865F2; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 1rem; width: 100%; }
        .upload-form button:hover { background-color: #4752c4; }
        .status { padding: 8px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin-top: 1rem; }
        .status-analise { background-color: #faa61a; }
        .status-pending_approval { background-color: #faa61a; color: #fff; }
        .status-approved { background-color: #43b581; }
    </style>
</head>
<body>
    <div class="container">
        <% if (order.status === 'pending_approval') { %>
            <h1>✅ Comprovante Enviado!</h1>
            <p>Seu comprovante foi recebido e está em análise. Você será notificado assim que for aprovado.</p>
            <div class="status status-pending_approval">Aguardando Aprovação</div>
        <% } else { %>
            <h1>Finalize seu Pagamento</h1>
            <p>Para concluir sua compra, faça o pagamento usando a chave PIX abaixo e envie o comprovante.</p>

            <div class="product-info">
                <h2><%= product.name %></h2>
                <p class="price">R$ <%= parseFloat(product.price).toFixed(2) %></p>
            </div>

            <div class="pix-section">
                <h3>Chave PIX (Copia e Cola)</h3>
                <div class="pix-key">8e2dd08f-c741-499a-a7ac-cbddd415f5f7</div>
            </div>

            <form class="upload-form" action="/order/upload/<%= order.id %>" method="POST" enctype="multipart/form-data">
                <label for="receipt">Selecione o arquivo do comprovante:</label>
                <input type="file" id="receipt" name="receipt" accept="image/*" required>
                <button type="submit">Enviar Comprovante</button>
            </form>
        <% } %>
    </div>

    <script>
        // Script para atualizar o status em tempo real
        const orderId = "<%= order.id %>";
        const currentStatus = "<%= order.status %>";

        function checkStatus(container) {
            // Só começa a verificar se o comprovante já foi enviado
            if (currentStatus !== 'pending_approval') return;

            fetch(`/order/status/${orderId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'approved') {
                        // Aprovado: mostra mensagem e redireciona
                        container.innerHTML = `
                            <h1>✅ Comprovante Aprovado!</h1>
                            <p>Seu pagamento foi confirmado. Redirecionando para o chat de entrega...</p>
                            <div class="status status-approved">Aprovado</div>
                        `;
                        setTimeout(() => { window.location.href = `/order/chat/${orderId}`; }, 3000); // Redireciona após 3 segundos
                    } else if (data.status === 'declined') {
                        // Recusado: mostra mensagem de erro
                        container.innerHTML = `
                            <h1>❌ Comprovante Recusado</h1>
                            <p>Seu comprovante foi analisado e recusado. Se você acha que isso é um erro, contate o suporte da Jyl Store.</p>
                        `;
                    }
                })
                .catch(err => console.error('Erro ao verificar status:', err));
        }

        // Inicia a verificação de status
        const container = document.querySelector('.container');
        const statusInterval = setInterval(() => checkStatus(container), 5000);

        // Para o intervalo se a página for fechada
        window.addEventListener('beforeunload', () => {
            clearInterval(statusInterval);
        });
    </script>
</body>
</html>